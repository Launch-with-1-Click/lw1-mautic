require 'base64'

def adjust_location
  location = {}
  case node.ec2.placement_availability_zone
  when /^ap-northeast/
    location[:lang] = "ja"
    location[:zone] = "Asia/Tokyo"
  else
    location[:lang] = "en"
    location[:zone] = "UTC"
  end
  location
end

mautic_location = adjust_location
mautic_ver = "<%= node[:lw1_mautic][:install][:version] %>"

file '/etc/httpd/conf.d/welcome.conf' do
  action :delete
end

service 'mysqld' do
  action [:enable, :start]
end

bash 'mysql_secure_install emulate' do
  code <<-"EOH"
    /usr/bin/mysqladmin drop test -f
    /usr/bin/mysql -e "DELETE FROM user WHERE user = '';" -D mysql
    /usr/bin/mysql -e "DELETE FROM mysql.user WHERE User='root' AND Host NOT IN ('localhost', '127.0.0.1', '::1');" -D mysql
    /usr/bin/mysql -e "SET PASSWORD FOR 'root'@'::1' = PASSWORD('#{node.ec2.instance_id}');" -D mysql
    /usr/bin/mysql -e "SET PASSWORD FOR 'root'@'127.0.0.1' = PASSWORD('#{node.ec2.instance_id}');" -D mysql
    /usr/bin/mysql -e "SET PASSWORD FOR 'root'@'localhost' = PASSWORD('#{node.ec2.instance_id}');" -D mysql
    /usr/bin/mysqladmin flush-privileges -pnewpassword -p#{node.ec2.instance_id}
  EOH
  action :run
  only_if "/usr/bin/mysql -u root -e 'show databases;'"
end

package 'mod24_ssl'


template "/etc/php.d/date.ini" do
  local true
  source "/opt/lw1/tasks/date.ini.erb"
  variables mautic_location
end

template "/var/www/html/app/config/local.php" do
  local true
  mode  '0600'
  owner "apache"
  group "apache"
  source "/opt/lw1/tasks/local.php.erb"
end

directory "/opt/lw1/ORM" do
  mode  '0600'
  owner "apache"
  group "apache"
end

template "/var/www/html/app/bundles/InstallBundle/InstallFixtures/ORM/LoadUserData.php" do
  local true
  mode  '0600'
  owner "apache"
  group "apache"
  source "/opt/lw1/fixtures-templates/#{mautic_ver}/LoadUserData.php.erb"
end

bash 'install mautic by doctrine' do
  cwd "/var/www/html"
  code <<-"EOH"
    sudo -u apache php app/console doctrine:database:create --env=prod --no-interaction
    sudo -u apache php app/console doctrine:migrations:status --env=prod --no-interaction
    sudo -u apache php app/console doctrine:schema:create --env=prod --no-interaction
    sudo -u apache php app/console doctrine:migrations:migrate --env=prod --no-interaction
    sudo -u apache php app/console doctrine:fixtures:load --env=prod --fixtures=app/bundles/InstallBundle/InstallFixtures/ --no-interaction
    touch /opt/lw1/.fixtures_done
  EOH
  action :run
  creates "/opt/lw1/.fixtures_done"
end


service 'httpd' do
  action [:enable, :start]
end

cron "setup_mautic_on_init" do
  action :delete
  end
